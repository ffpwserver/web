window.__require=function t(e,o,n){function i(r,a){if(!o[r]){if(!e[r]){var l=r.split("/");if(l=l[l.length-1],!e[l]){var s="function"==typeof __require&&__require;if(!a&&s)return s(l,!0);if(c)return c(l,!0);throw new Error("Cannot find module '"+r+"'")}r=l}var u=o[r]={exports:{}};e[r][0].call(u.exports,function(t){return i(e[r][1][t]||t)},u,u.exports,t,e,o,n)}return o[r].exports}for(var c="function"==typeof __require&&__require,r=0;r<n.length;r++)i(n[r]);return i}({Main:[function(t,e,o){"use strict";cc._RF.push(e,"2f74a2xszZOr7gRjuBK5oIJ","Main");var n,i=this&&this.__extends||(n=function(t,e){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o])})(t,e)},function(t,e){function o(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(o.prototype=e.prototype,new o)}),c=this&&this.__decorate||function(t,e,o,n){var i,c=arguments.length,r=c<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,o,n);else for(var a=t.length-1;a>=0;a--)(i=t[a])&&(r=(c<3?i(r):c>3?i(e,o,r):i(e,o))||r);return c>3&&r&&Object.defineProperty(e,o,r),r};Object.defineProperty(o,"__esModule",{value:!0});var r=cc._decorator,a=r.ccclass,l=r.property,s=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.bg=null,e.npc=null,e.cloudFrame=null,e.cellRoot=null,e.combineButtonBg=null,e.combineButton=null,e.upperNode=null,e.maskNode=null,e.topNode=null,e.enterButton=null,e.clickSound=null,e.combineSound=null,e.waterSound=null,e.rollSound=null,e.videoPlayer=null,e.boomEffect=null,e.material=null,e.waveOffset=0,e.startWave=!1,e.cellArray=null,e.isUnlocking=[],e.centerPos=null,e.fadePct=1,e.maxDistance=0,e}return i(e,t),e.prototype.onLoad=function(){var t=this;window.Main=this,cc.view.setResizeCallback(function(){return t.adapt()}),this.adapt(),cc.director.getCollisionManager().enabled=!0;var e=this.combineButton.node.convertToWorldSpaceAR(cc.Vec2.ZERO);this.centerPos=this.cellRoot.convertToNodeSpaceAR(e),this.combineButton.node.active=!1,this.npc.node.active=!1,this.enterButton.node.active=!1,this.combineButton.node.active=!1,this.cellRoot.opacity=0,this.combineButtonBg.opacity=0,this.cloudFrame.scale=3,this.maskNode.opacity=0,this.videoPlayer.node.active=!1,this.boomEffect.node.active=!1},e.prototype.start=function(){var t=this;this.cellArray=[].concat(this.cellRoot.children),this.cellArray.sort(function(e,o){return e.getPosition().sub(t.centerPos).mag()-o.getPosition().sub(t.centerPos).mag()}),this.maxDistance=this.cellArray[this.cellArray.length-1].getPosition().sub(this.centerPos).mag();for(var e=0,o=this.cellArray;e<o.length;e++)o[e],this.isUnlocking.push(!1);this.material=this.bg.getComponent(cc.Sprite).getMaterial(0),this.bg.on(cc.Node.EventType.TOUCH_START,this.onTouchStart,this),this.npc.addEventListener(dragonBones.EventObject.LOOP_COMPLETE,this.onFrameEvent,this),this.cellArray.forEach(function(e){e.children[0]&&(e.children[0].color=cc.Color.BLACK,e.children[0].opacity=150),e.on(cc.Node.EventType.TOUCH_START,t.onCellTouchStart,t),e._touchListener.setSwallowTouches(!1)}),this.combineButton.node.on("click",this.onCombineClick,this),this.enterButton.node.on("click",this.onEnterClick,this),this.videoPlayer.node.on("completed",this.onVideoPlayCompleted,this),cc.audioEngine.playEffect(this.waterSound,!1),this.waterWaveAt(cc.v2(this.bg.width/2,this.bg.height/2)),cc.tween(this.maskNode).to(2,{opacity:180}).call(function(){return t.playEnterAnim()}).start()},e.prototype.playEnterAnim=function(){var t=this;cc.tween(this.cloudFrame).to(1.8,{scale:1},{easing:"bounceOut"}).start(),cc.tween(this.cellRoot).delay(1.2).to(2,{opacity:255}).start(),cc.tween(this.combineButtonBg).delay(1.2).to(2,{opacity:255}).call(function(){t.npc.node.active=!0,t.npc.playAnimation("chuxian",1)}).start()},e.prototype.onDestroy=function(){},e.prototype.onTouchStart=function(t){var e=t.getLocation();this.waterWaveAt(e)},e.prototype.waterWaveAt=function(t){this.material.setProperty("center",[t.x/this.bg.width,1-t.y/this.bg.height]),this.waveOffset=0,this.startWave=!0},e.prototype.onCellTouchStart=function(t){var e=t.target,o=this.cellArray.indexOf(e);if(!this.isUnlocking[o]){var n=t.getLocation(),i=t.target.convertToNodeSpaceAR(n),c=t.target.getComponent(cc.PolygonCollider);c&&cc.Intersection.pointInPolygon(i,c.points)&&(cc.audioEngine.playEffect(this.clickSound,!1),e.children[0].active?(this.isUnlocking[o]=!0,this.showUnlockingAnim(o,e,.1,.8)):this.scaleTarget(e))}},e.prototype.showUnlockingAnim=function(t,e,o,n){var i=this;void 0===o&&(o=.05),void 0===n&&(n=1),e.setSiblingIndex(this.cellArray.length),this.useOutterGlow(e,!0);var c=e.children[0],r=0,a=c.getComponent(cc.Sprite).getMaterial(0);a.setProperty("u_fade_radius",o),a.setProperty("u_time",r),a.define("USE_TRANSFORM",!0,0,!0);var l=function(){r+=.03,a.setProperty("u_time",r/n),r>n+o&&(a.define("USE_TRANSFORM",!1,0,!0),c.active=!1,i.isUnlocking[t]=!1,i.unschedule(l),i.npc.playAnimation("kaixin",1),i.scaleTarget(e),i.checkAllUnlocked()&&i.runButtonEnterAnim())};this.schedule(l,.03)},e.prototype.scaleTarget=function(t){var e=this;t.setSiblingIndex(this.cellArray.length),t.scale=1,cc.tween(t).to(.8,{scale:1.08},{easing:"backOut"}).to(.8,{scale:1}).call(function(){return e.useOutterGlow(t,!1)}).start()},e.prototype.runButtonEnterAnim=function(){var t=this;cc.audioEngine.playEffect(this.rollSound,!1),cc.Tween.stopAllByTarget(this.combineButton.node),this.combineButton.node.active=!0,this.combineButton.node.scaleX=.3,this.combineButton.node.scaleY=.01,cc.tween(this.combineButton.node).to(2,{scale:1},{easing:"elasticOut"}).call(function(){cc.tween(t.combineButton.node).repeatForever(cc.tween().to(2,{scale:1.08}).to(2,{scale:1})).start()}).start()},e.prototype.checkAllUnlocked=function(){for(var t=0,e=this.cellRoot.children;t<e.length;t++)if(e[t].children[0].active)return!1;return!0},e.prototype.update=function(t){this.waveOffset>1.2?this.startWave=!1:this.startWave&&(this.waveOffset+=t,this.material.setProperty("wave_offset",this.waveOffset))},e.prototype.onFrameEvent=function(t){var e=this,o=t.animationState.name,n=["dazhaohu","yihuo"];n.includes(o)||"kaixin"===o?this.scheduleOnce(function(){var t=e.randomRange(0,n.length),o=n[t];e.npc.playAnimation(o,1)},.5):"chuxian"===o&&this.scheduleOnce(function(){e.npc.playAnimation("dazhaohu",1)},.5)},e.prototype.randomRange=function(t,e){var o;return t>e&&(t=(o=[e,t])[0],e=o[1]),Math.floor(Math.random()*(e-t)+t)},e.prototype.onCombineClick=function(){cc.audioEngine.playEffect(this.combineSound,!1),this.combineButton.interactable=!1,this.playCombineAnim()},e.prototype.onEnterClick=function(){},e.prototype.playCombineAnim=function(){var t=this;this.npc.node.active=!1,this.boomEffect.node.active=!0,this.boomEffect.setAnimation(0,"g",!1),cc.tween(this.boomEffect.node).to(3,{scale:3}).start(),cc.tween(this.combineButtonBg).to(.2,{opacity:0}).call(function(){t.combineButtonBg.active=!1}).start();for(var e=[],o=0,n=this.cellArray;o<n.length;o++){var i=n[o];e.push(i.getPosition())}for(var c=[],r=[],a=0,l=e;a<l.length;a++){var s=l[a];r.push(1-.75*Math.random()),c.push(s.sub(this.centerPos).mul(2*Math.random()+1.5).add(this.centerPos))}for(var u=0;u<c.length;++u){var p=this.cellArray[u];cc.tween(p).delay(.01*u).to(1,{x:c[u].x,y:c[u].y,scale:r[u]},{easing:"expoOut"}).to(.08,{angle:-2}).to(.08,{angle:3}).to(.08,{angle:-4}).to(.08,{angle:3}).to(.08,{angle:-2}).to(.08,{angle:0}).delay(.35-.01*u).to(.05,{x:this.combineButton.node.x,y:this.combineButton.node.y,scale:0}).start()}cc.tween(this.cloudFrame).to(1,{scale:4}).delay(.83+.01*this.cellArray.length).call(function(){t.upperNode.active=!1,t.topNode.active=!1,t.bg.active=!1,t.videoPlayer.node.active=!0,t.videoPlayer.node.scale=0,cc.tween(t.videoPlayer.node).delay(.2).to(.2,{scale:1}).call(function(){return t.videoPlayer.play()}).start()}).start()},e.prototype.adapt=function(){var t=cc.view.getDesignResolutionSize();cc.winSize.width/cc.winSize.height<=t.width/t.height?(cc.Canvas.instance.fitHeight=!1,cc.Canvas.instance.fitWidth=!0):(cc.Canvas.instance.fitHeight=!0,cc.Canvas.instance.fitWidth=!1)},e.prototype.onVideoPlayCompleted=function(){console.log("play completed")},e.prototype.useOutterGlow=function(t,e){void 0===e&&(e=!1),t.getComponent(cc.RenderComponent).getMaterial(0).define("SHOW_OUTTER_GLOW",e,0,e)},c([l(cc.Node)],e.prototype,"bg",void 0),c([l(dragonBones.ArmatureDisplay)],e.prototype,"npc",void 0),c([l(cc.Node)],e.prototype,"cloudFrame",void 0),c([l(cc.Node)],e.prototype,"cellRoot",void 0),c([l(cc.Node)],e.prototype,"combineButtonBg",void 0),c([l(cc.Button)],e.prototype,"combineButton",void 0),c([l(cc.Node)],e.prototype,"upperNode",void 0),c([l(cc.Node)],e.prototype,"maskNode",void 0),c([l(cc.Node)],e.prototype,"topNode",void 0),c([l(cc.Button)],e.prototype,"enterButton",void 0),c([l(cc.AudioClip)],e.prototype,"clickSound",void 0),c([l(cc.AudioClip)],e.prototype,"combineSound",void 0),c([l(cc.AudioClip)],e.prototype,"waterSound",void 0),c([l(cc.AudioClip)],e.prototype,"rollSound",void 0),c([l(cc.VideoPlayer)],e.prototype,"videoPlayer",void 0),c([l(sp.Skeleton)],e.prototype,"boomEffect",void 0),c([a],e)}(cc.Component);o.default=s,cc._RF.pop()},{}]},{},["Main"]);